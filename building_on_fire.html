<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>City Fire & Smoke Simulation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script type="importmap">
    {
      "imports": {
        "p5": "https://cdn.jsdelivr.net/npm/p5@1.7.0/+esm"
      }
    }
  </script>
  <style>
    body {
      margin: 0;
      background: linear-gradient(to bottom, #b7dcff 0%, #6b8abe 100%);
      height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #sidebar {
      position: fixed;
      right: 0; top: 0; bottom: 0;
      width: 270px;
      background: rgba(250,252,255,0.98);
      box-shadow: -8px 0 24px #1c225a12;
      z-index: 10;
      padding: 28px 18px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      align-items: flex-start;
      border-top-left-radius: 30px;
      border-bottom-left-radius: 30px;
    }
    .slider-label { font-size: 16px; color: #2d3348; font-weight: 500; margin-bottom: 4px; }
    .slider-group { margin-bottom: 8px; width: 100%; }
    input[type=range] { width: 120px; accent-color: #ffb100; background: #ffe8cc; border-radius: 12px; height: 3px; }
    .value-label { margin-left: 10px; min-width: 34px; font-family: monospace; color: #666; font-size: 14px; display: inline-block; }
    #legend { font-size: 16px; margin-top: 12px; color: #36405a; }
    #legend .legend-row { display: flex; align-items: center; margin-bottom: 7px; gap: 7px; }
    #legend .colorbox, #legend .ellipsebox { width: 19px; height: 13px; display: inline-block; margin-right: 5px; border-radius: 4px; }
    #legend .ellipsebox { border-radius: 50%; }
    #resetBtn {
      background: linear-gradient(90deg, #ffad00 40%, #ff3838 100%);
      color: white;
      font-size: 16px;
      padding: 8px 24px;
      border: none;
      border-radius: 10px;
      margin-top: 3px;
      font-weight: bold;
      box-shadow: 0 3px 12px #ffb63822;
      cursor: pointer;
      letter-spacing: 0.7px;
    }
    @media (max-width: 900px) {
      #sidebar { width: 110px; font-size: 11px; padding: 7px 4px 6px 7px;}
      .slider-label, #legend { font-size: 11px;}
      input[type=range] { width: 65px;}
      #resetBtn { font-size: 11px; padding: 4px 9px;}
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div style="font-size:21px;color:#283864;font-weight:800;letter-spacing:1.1px;margin-bottom:2px;">
      <span style="font-size:22px;">üî•üèôÔ∏è</span>
      <span style="vertical-align:2px;">Fire City</span>
    </div>
    <div class="slider-group">
      <div class="slider-label">Wind</div>
      <input type="range" min="-1.5" max="2.0" step="0.01" value="0.4" id="windSlider">
      <span class="value-label" id="windVal">0.40</span>
    </div>
    <div class="slider-group">
      <div class="slider-label">Fire Intensity</div>
      <input type="range" min="0.7" max="2.4" step="0.01" value="1.1" id="fireSlider">
      <span class="value-label" id="fireVal">1.10</span>
    </div>
    <div class="slider-group">
      <div class="slider-label">Smoke Intensity</div>
      <input type="range" min="0.6" max="2.0" step="0.01" value="1.0" id="smokeSlider">
      <span class="value-label" id="smokeVal">1.00</span>
    </div>
    <button id="resetBtn">Reset</button>
    <div id="legend">
      <div class="legend-row">
        <span class="ellipsebox" style="background:radial-gradient(circle at 60% 20%, #fffbc2 15%, #ffbc00 50%, #e34709 90%);"></span>
        <span>Flames</span>
      </div>
      <div class="legend-row">
        <span class="ellipsebox" style="background:radial-gradient(ellipse at 60% 40%, #fff,#e7e7eb 50%, #989caa 90%);"></span>
        <span>Smoke</span>
      </div>
      <div class="legend-row">
        <span class="colorbox" style="background:#b8bac1;border:1.5px solid #777;"></span>
        <span>Wall</span>
      </div>
      <div class="legend-row">
        <span class="colorbox" style="background:#9ed5f9;border:1.5px solid #4696d9;"></span>
        <span>Window</span>
      </div>
      <div class="legend-row">
        <span class="colorbox" style="background:#88562e;border:1.5px solid #432c12;"></span>
        <span>Door</span>
      </div>
      <div class="legend-row">
        <span class="ellipsebox" style="background:#666;"></span>
        <span>Bird</span>
      </div>
      <div class="legend-row">
        <span class="colorbox" style="background:#f00; border:1.5px solid #fff;"></span>
        <span>Fire Truck</span>
      </div>
      <div class="legend-row">
        <span class="colorbox" style="background:#666; border:1.5px solid #222;"></span>
        <span>Road</span>
      </div>
    </div>
  </div>
  <script type="module">
    import p5 from "p5";

    const CANVAS_H = window.innerHeight;
    const CANVAS_W = window.innerWidth - 270;
    let wind = 0.4, fireIntensity = 1.1, smokeIntensity = 1.0;

    let sketch = function(p) {
      // -- Layout/Geometry
      let MARGIN = CANVAS_W * 0.13;
      let buildingW = (CANVAS_W - MARGIN * 2 - 60) / 2;
      let buildingH = CANVAS_H * 0.5;
      let roadY = CANVAS_H * 0.22 + buildingH + 28;
      let FLOORS = 5, ROOMS = 3;
      let buildings = [
        { id: 1, x: MARGIN, y: CANVAS_H * 0.22, color: p => p.color(211,220,233) },
        { id: 2, x: MARGIN + buildingW + 60, y: CANVAS_H * 0.22, color: p => p.color(235,237,242) }
      ];
      let city = [];
      let fires = [];
      let smokes = [];
      let birds = [];
      let trucks = [null, null];
      let hoverRoom = null; // FIX: ensure hoverRoom is declared

      function buildCityState() {
        city = [];
        for (let b = 0; b < buildings.length; b++) {
          let bld = buildings[b];
          for (let f = 0; f < FLOORS; f++) {
            for (let r = 0; r < ROOMS; r++) {
              let x = bld.x + r * (buildingW / ROOMS);
              let y = bld.y + f * (buildingH / FLOORS);
              let w = buildingW / ROOMS;
              let h = buildingH / FLOORS;
              city.push({
                building: b,
                f, r,
                burning: false,
                x, y, w, h
              });
            }
          }
        }
      }

      function setupBirds() {
        birds = [];
        for (let i=0;i<8;i++) {
          birds.push({
            x: p.random(40, CANVAS_W-110),
            y: p.random(40, CANVAS_H*0.13),
            vx: p.random(1.1,1.8) * (i%2===0?1:-1),
            vy: p.random(-0.09,0.07),
            flap: p.random(0,100),
            size: p.random(16,24),
            color: i%3==0 ? p.color(67,67,69) : p.color(140,140,146)
          });
        }
      }

      function setupTrucks() {
        trucks = [
          {
            x: -160, y: roadY + 3, targetX: buildings[0].x + buildingW * 0.12,
            state: "idle", stopX: buildings[0].x + buildingW*0.12, light: 0
          },
          {
            x: CANVAS_W + 60, y: roadY + 3, targetX: buildings[1].x + buildingW * 0.82,
            state: "idle", stopX: buildings[1].x + buildingW*0.82, light: 0
          }
        ];
      }

      p.setup = function() {
        p.createCanvas(CANVAS_W, CANVAS_H).parent(document.body);
        buildCityState();
        fires = [];
        smokes = [];
        setupBirds();
        setupTrucks();
      };

      p.draw = function() {
        drawSky();
        drawSunAndClouds();
        drawRoad();
        drawCity();
        updateFires();
        updateSmokes();
        drawFires();
        drawSmokes();
        drawBirds();
        updateAndDrawTrucks();
        drawHoverHighlight();
      };

      function drawSky() {
        for (let y = 0; y < CANVAS_H; y++) {
          let c1 = p.color('#cde2f8'), c2 = p.color('#5983c6');
          let cc = p.lerpColor(c1, c2, y/CANVAS_H);
          p.stroke(cc);
          p.line(0, y, CANVAS_W, y);
        }
      }

      function drawSunAndClouds() {
        p.noStroke();
        p.fill(255,238,160,90); p.ellipse(CANVAS_W*0.77, 90, 120, 120);
        p.fill(255,252,205,70); p.ellipse(CANVAS_W*0.79, 98, 64, 64);
        let cloudArr = [
          [CANVAS_W*0.23,75,65],[CANVAS_W*0.33,66,35],[CANVAS_W*0.47,85,58],
          [CANVAS_W*0.68,60,43],[CANVAS_W*0.57,110,50],[CANVAS_W*0.38,120,35]
        ];
        for(let [cx,cy,sx] of cloudArr){
          p.fill(255,255,255,95);
          p.ellipse(cx,cy,sx,21+8*Math.abs(Math.sin(cx*0.01)));
        }
      }

      function drawRoad() {
        p.noStroke();
        p.fill(68,68,70,245);
        p.rect(0, roadY, CANVAS_W, 48);
        p.stroke(255,255,80,210); p.strokeWeight(4);
        for(let x=0;x<CANVAS_W;x+=56)
          p.line(x+14, roadY+24, x+38, roadY+24);
      }

      function drawCity() {
        hoverRoom = null;
        for (let b = 0; b < buildings.length; b++) {
          let bld = buildings[b];
          p.noStroke();
          p.fill(50,68,100,34);
          p.rect(bld.x+8, bld.y+buildingH-2, buildingW-7, 18, 12);

          p.stroke('#555'); p.strokeWeight(5.0);
          p.fill(bld.color(p));
          p.rect(bld.x, bld.y, buildingW, buildingH, 13);

          p.strokeWeight(2); p.stroke('#7e8ca3');
          for(let f=1;f<FLOORS;f++){
            let y = bld.y + f*(buildingH/FLOORS);
            p.line(bld.x, y, bld.x+buildingW, y);
          }
          for(let r=1;r<ROOMS;r++){
            let x = bld.x + r*(buildingW/ROOMS);
            p.line(x, bld.y, x, bld.y+buildingH);
          }

          for(let f=0;f<FLOORS;f++){
            for(let r=0;r<ROOMS;r++){
              let rx = bld.x + r*(buildingW/ROOMS);
              let ry = bld.y + f*(buildingH/FLOORS);
              let w = buildingW/ROOMS, h = buildingH/FLOORS;
              let winSz = Math.min(w,h)*0.38;
              let wx = rx+w/2-winSz/2, wy = ry+h*0.21;
              p.noStroke(); p.fill(158,210,249,240);
              p.rect(wx, wy, winSz, winSz, 4);
              p.stroke(75,130,180,180); p.strokeWeight(2.1);
              p.line(wx+winSz/2, wy+4, wx+winSz/2, wy+winSz-4);
              p.line(wx+4, wy+winSz/2, wx+winSz-4, wy+winSz/2);
            }
          }
          for(let r=0;r<ROOMS;r++){
            let rx = bld.x + r*(buildingW/ROOMS);
            let ry = bld.y + (FLOORS-1)*(buildingH/FLOORS);
            let w = buildingW/ROOMS, h = buildingH/FLOORS;
            let doorW = w*0.5, doorH = h*0.92;
            let dx = rx+w/2-doorW/2, dy = ry+h-doorH;
            p.noStroke(); p.fill('#88562e');
            p.rect(dx, dy, doorW, doorH, 4);
            p.fill(212,190,91,220); p.ellipse(dx+doorW*0.81, dy+doorH*0.65, 7,7);
          }
        }
      }

      function drawHoverHighlight() {
        let mx = p.mouseX, my = p.mouseY;
        for (const room of city) {
          if (
            mx > room.x && mx < room.x + room.w &&
            my > room.y && my < room.y + room.h
          ) {
            p.noFill();
            p.stroke('#ff7c14'); p.strokeWeight(3.3);
            p.rect(room.x+1, room.y+1, room.w-2, room.h-2, 7);
            hoverRoom = room;
          }
        }
      }

      function updateFires() {
        let perBuildingFires = [0, 0];
        for (const room of city) {
          if (room.burning) {
            perBuildingFires[room.building]++;
            let n = Math.floor(p.random(1,3)*fireIntensity);
            for (let i = 0; i < n; i++) {
              let fx = p.random(room.x+room.w*0.13, room.x+room.w*0.87);
              let fy = p.random(room.y+room.h*0.70, room.y+room.h*0.98);
              let angle = wind * p.random(0.13, 0.29);
              fires.push({
                building: room.building,
                x: fx, y: fy,
                vx: angle + p.random(-0.08,0.10),
                vy: p.random(-1.0,-1.7)*fireIntensity,
                size: p.random(10,16)*fireIntensity,
                lifetime: p.random(19,33),
                maxLifetime: 33,
                tip: Math.abs(angle)>0.01,
              });
            }
            if (p.random() < (0.008 + 0.008*fireIntensity)) {
              let neighbors = [];
              for (const neighbor of city) {
                if (neighbor.building===room.building) {
                  let df = neighbor.f-room.f, dr = neighbor.r-room.r;
                  if ((df===-1 && Math.abs(dr)<=1) || (df===0 && Math.abs(dr)===1)) {
                    if (!neighbor.burning && p.random()<0.44+0.09*Math.abs(wind)) {
                      neighbors.push(neighbor);
                    }
                  }
                }
              }
              if (neighbors.length && p.random()<0.45) neighbors[p.floor(p.random(neighbors.length))].burning = true;
            }
            if (smokes.length < 300 && p.random()<0.74*smokeIntensity) {
              smokes.push({
                x: room.x+room.w/2 + p.random(-13,13),
                y: room.y+room.h*0.13 - p.random(2,10),
                vx: p.random(-0.09,0.10)+wind*0.27,
                vy: p.random(-0.69,-0.46)*smokeIntensity,
                size: p.random(12,22)*smokeIntensity,
                lifetime: p.random(32,72),
                maxLifetime: 72,
                expand: p.random(0.008,0.04)
              });
            }
          }
        }
        for (let i=fires.length-1;i>=0;i--) {
          let f = fires[i];
          f.x += f.vx;
          f.y += f.vy;
          f.lifetime--;
          if (f.lifetime<=0) fires.splice(i,1);
        }

        for (let b = 0; b < trucks.length; b++) {
          let fireCount = perBuildingFires[b];
          if (fireCount > 7) {
            trucks[b].state = "approaching";
          } else if (fireCount === 0) {
            trucks[b].state = "leaving";
          }
        }
      }

      function updateSmokes() {
        for (let i=smokes.length-1;i>=0;i--) {
          let s = smokes[i];
          s.x += s.vx;
          s.y += s.vy;
          s.size += s.expand;
          s.vx *= 0.984;
          s.lifetime--;
          if (s.lifetime<=0) smokes.splice(i,1);
        }
      }
      function drawFires() {
        for (let f of fires) {
          let life = f.lifetime/f.maxLifetime;
          let colorTip = p.lerpColor(p.color(255, 47, 5), p.color(255,200,9), 1-life);
          let colorCore = p.lerpColor(p.color(255,250,200), p.color(255,170,50), 1-life);
          p.noStroke();
          p.fill(colorTip.levels[0],colorTip.levels[1],colorTip.levels[2], 115+110*life);
          p.ellipse(f.x, f.y, f.size*1.07, f.size*1.25);
          p.fill(colorCore.levels[0],colorCore.levels[1],colorCore.levels[2], 140+60*life);
          p.ellipse(f.x, f.y-f.size*0.14, f.size*0.72, f.size*0.82);
          if (f.tip && life>0.68) {
            p.fill(255,180+50*p.random(),90+80*p.random(),80*life);
            let tipx = f.x+f.size*p.random(-0.17,0.17)+wind*2.2;
            let tipy = f.y-f.size*0.53;
            p.ellipse(tipx, tipy, f.size*0.22, f.size*0.41);
          }
        }
      }
      function drawSmokes() {
        for (let s of smokes) {
          let alpha = 46*(s.lifetime/s.maxLifetime) + 12;
          let grey = p.lerpColor(p.color(220,220,230,alpha), p.color(100,120,150,alpha*0.7), 1-s.lifetime/s.maxLifetime);
          p.noStroke(); p.fill(grey);
          p.ellipse(s.x, s.y, s.size, s.size*1.17);
        }
      }

      function drawBirds() {
        for (let bird of birds) {
          bird.x += bird.vx;
          bird.y += bird.vy + p.sin(p.frameCount*0.09+bird.flap)*0.7;
          bird.flap += 0.12 + 0.06*p.noise(bird.x*0.01);
          if (bird.x > CANVAS_W+30) { bird.x = -40; bird.y = p.random(50, CANVAS_H*0.14);}
          if (bird.x < -50) { bird.x = CANVAS_W+20; bird.y = p.random(50, CANVAS_H*0.14);}
          let wing = Math.sin(bird.flap)*bird.size*0.7;
          p.push();
          p.translate(bird.x, bird.y);
          p.scale(bird.vx>0?1:-1, 1);
          p.noStroke();
          p.fill(bird.color.levels[0]*0.8, bird.color.levels[1]*0.8, bird.color.levels[2]*0.8, 210);
          p.ellipse(-bird.size*0.01, -bird.size*0.07, bird.size*0.8+wing, bird.size*0.2+Math.abs(wing)*0.09);
          p.ellipse(-bird.size*0.01, bird.size*0.07, bird.size*0.8-wing, bird.size*0.19+Math.abs(wing)*0.09);
          p.fill(bird.color);
          p.ellipse(0, 0, bird.size, bird.size*0.64);
          p.ellipse(-bird.size*0.26, -bird.size*0.13, bird.size*0.31, bird.size*0.18);
          p.fill(255,204,82); p.triangle(-bird.size*0.38,-bird.size*0.13,-bird.size*0.49,-bird.size*0.08,-bird.size*0.39,-bird.size*0.01);
          p.fill(34); p.ellipse(-bird.size*0.29,-bird.size*0.15,2.2,2.2);
          p.pop();
        }
      }

      function updateAndDrawTrucks() {
        let truckW = 76, truckH = 26;
        for (let t = 0; t < trucks.length; t++) {
          let truck = trucks[t];
          if (truck.state === "approaching") {
            if (t === 0) truck.x += 3.2;
            else truck.x -= 3.2;
            if ((t===0 && truck.x >= truck.stopX) || (t===1 && truck.x <= truck.stopX)) {
              truck.x = truck.stopX;
            }
          } else if (truck.state === "leaving") {
            if (t === 0) truck.x -= 4.2;
            else truck.x += 4.2;
          }
          if (truck.x < -160) truck.x = -160;
          if (truck.x > CANVAS_W + 60) truck.x = CANVAS_W + 60;
          // Draw
          if (truck.state !== "idle") {
            p.push();
            p.translate(truck.x, truck.y);
            p.stroke('#fff'); p.strokeWeight(2.2); p.fill('#f01421');
            p.rect(0, 0, truckW, truckH, 6);
            p.fill(230); p.noStroke(); p.rect(truckW-24, 5, 19, truckH-10, 4);
            p.fill(40); p.ellipse(14, truckH+6, 14,14); p.ellipse(truckW-18, truckH+6, 14,14);
            p.stroke(220); p.strokeWeight(2.1); p.line(truckW-34, 10, truckW-2, 10); p.line(truckW-34, 15, truckW-2, 15);
            let siren = p.frameCount % 30 < 15 ? '#53b8ff' : '#fff706';
            p.noStroke(); p.fill(siren); p.ellipse(truckW-10, 0, 9,8);
            p.pop();
          }
        }
      }

      p.mousePressed = function() {
        let mx = p.mouseX, my = p.mouseY;
        for (const room of city) {
          if (
            mx > room.x && mx < room.x + room.w &&
            my > room.y && my < room.y + room.h
          ) {
            if (!room.burning) {
              room.burning = true;
              return;
            }
          }
        }
      };

      window.resetSimulation = function() {
        buildCityState();
        fires.length = 0;
        smokes.length = 0;
        setupBirds();
        setupTrucks();
      };
    };

    new p5(sketch);

    document.getElementById('windSlider').oninput = e => {
      wind = parseFloat(e.target.value);
      document.getElementById('windVal').textContent = wind.toFixed(2);
    };
    document.getElementById('fireSlider').oninput = e => {
      fireIntensity = parseFloat(e.target.value);
      document.getElementById('fireVal').textContent = fireIntensity.toFixed(2);
    };
    document.getElementById('smokeSlider').oninput = e => {
      smokeIntensity = parseFloat(e.target.value);
      document.getElementById('smokeVal').textContent = smokeIntensity.toFixed(2);
    };
    document.getElementById('resetBtn').onclick = () => window.location.reload();

  </script>
</body>
</html>
